# -*- python -*-
# ex: set syntax=python:

import params
from twisted.python import log

c = BuildmasterConfig = {}

c['buildbotNetUsageData'] = None


####### WORKERS

from buildbot.plugins import worker

docker_options = {
    'docker_host': params.DOCKER_HOST,
    'masterFQDN': params.DOCKER_MASTER_FQDN,
    'hostconfig': {
        'network_mode': 'host',
        'privileged': True,
    }
}

c['workers'] = [
    worker.Worker("windows", params.WINDOWS_WORKER_PASSWORD),
    worker.Worker("mac-m1", params.MAC_M1_WORKER_PASSWORD),
    worker.Worker("mac-bigsur", params.MAC_BIGSUR_WORKER_PASSWORD),
    worker.Worker("mac-mojave", params.MAC_MOJAVE_WORKER_PASSWORD),
    worker.DockerLatentWorker("manylinux-x86_64", params.MANYLINUX_X86_64_WORKER_PASSWORD,
        image="plawnekjxdotre/worker-manylinux-x86_64:latest",
        volumes=[
            "credentials:/home/buildbot/.credentials",
            "manylinux-x86_64-build:/worker/plawnekjx-manylinux-x86_64/build",
        ],
        **docker_options),
    #worker.Worker("rpi32", params.RPI32_WORKER_PASSWORD),
    #worker.Worker("rpi64", params.RPI64_WORKER_PASSWORD),

    worker.DockerLatentWorker("ubuntu_18_04-x86_64", params.UBUNTU_18_04_X86_64_WORKER_PASSWORD,
        image="plawnekjxdotre/worker-ubuntu-18.04-x86_64:latest",
        volumes=[
            "credentials:/home/buildbot/.credentials",
            "ubuntu_18_04-x86_64-build:/worker/plawnekjx-ubuntu_18_04-x86_64/build",
        ],
        **docker_options),
    worker.DockerLatentWorker("ubuntu_18_04-armhf", params.UBUNTU_18_04_ARMHF_WORKER_PASSWORD,
        image="plawnekjxdotre/worker-ubuntu-18.04-armhf:latest",
        volumes=[
            "credentials:/home/buildbot/.credentials",
            "ubuntu_18_04-armhf-build:/worker/plawnekjx-ubuntu_18_04-armhf/build",
        ],
        **docker_options),
    worker.DockerLatentWorker("ubuntu_18_04-arm64", params.UBUNTU_18_04_ARM64_WORKER_PASSWORD,
        image="plawnekjxdotre/worker-ubuntu-18.04-arm64:latest",
        volumes=[
            "credentials:/home/buildbot/.credentials",
            "ubuntu_18_04-arm64-build:/worker/plawnekjx-ubuntu_18_04-arm64/build",
        ],
        **docker_options),
    worker.DockerLatentWorker("ubuntu_20_04-x86_64", params.UBUNTU_20_04_X86_64_WORKER_PASSWORD,
        image="plawnekjxdotre/worker-ubuntu-20.04-x86_64:latest",
        volumes=[
            "credentials:/home/buildbot/.credentials",
            "ubuntu_20_04-x86_64-build:/worker/plawnekjx-ubuntu_20_04-x86_64/build",
        ],
        **docker_options),
    worker.DockerLatentWorker("ubuntu_21_04-x86_64", params.UBUNTU_21_04_X86_64_WORKER_PASSWORD,
        image="plawnekjxdotre/worker-ubuntu-21.04-x86_64:latest",
        volumes=[
            "credentials:/home/buildbot/.credentials",
            "ubuntu_21_04-x86_64-build:/worker/plawnekjx-ubuntu_21_04-x86_64/build",
        ],
        **docker_options),
    worker.DockerLatentWorker("fedora_35-x86_64", params.FEDORA_35_X86_64_WORKER_PASSWORD,
        image="plawnekjxdotre/worker-fedora-35-x86_64:latest",
        volumes=[
            "credentials:/home/buildbot/.credentials",
            "fedora_35-x86_64-build:/worker/plawnekjx-fedora_35-x86_64/build",
        ],
        **docker_options),
]
c['protocols'] = {
    "pb": {
        "port": 8007
    }
}


####### SCHEDULERS

from buildbot.schedulers.basic import SingleBranchScheduler
from buildbot.schedulers.forcesched import ForceScheduler
from buildbot.changes import filter

c['schedulers'] = []

main_builder_names = [
    "plawnekjx-windows",
    "plawnekjx-macos-modern",
    "plawnekjx-macos-legacy",
    "plawnekjx-macos-m1",
    "plawnekjx-manylinux-x86_64",
    #"plawnekjx-rpi32",
    #"plawnekjx-rpi64",
    "plawnekjx-ios",
    "plawnekjx-android",
    "plawnekjx-ubuntu_18_04-x86_64",
    "plawnekjx-ubuntu_18_04-armhf",
    "plawnekjx-ubuntu_18_04-arm64",
    "plawnekjx-ubuntu_20_04-x86_64",
    "plawnekjx-ubuntu_21_04-x86_64",
    "plawnekjx-fedora_35-x86_64"
]
c['schedulers'].append(SingleBranchScheduler(
                            name="all",
                            change_filter=filter.ChangeFilter(project="plawnekjx/plawnekjx", branch="main"),
                            treeStableTimer=5,
                            builderNames=main_builder_names))
c['schedulers'].append(ForceScheduler(
                            name="force",
                            builderNames=main_builder_names + ["plawnekjx-website"]))

c['schedulers'].append(SingleBranchScheduler(
                            name="website",
                            change_filter=filter.ChangeFilter(project="plawnekjx/plawnekjx-website", branch="main"),
                            treeStableTimer=5,
                            builderNames=["plawnekjx-website"]))


####### BUILDERS

from buildbot.process.factory import BuildFactory
from buildbot.plugins import steps
from buildbot.steps.source.git import Git
from buildbot.steps.vstudio import VS2017 as VS2022

vsdir = r"C:\Program Files\Microsoft Visual Studio\2022\Community"

def makePlawnekjxEnv():
    return {
        'MACOS_X86_SDK_ROOT': "/usr/local/opt/MacOSX10.13.sdk",
        'MACOS_CERTID': params.MACOS_CERTID,
        'IOS_CERTID': params.IOS_CERTID,
        'IOS_IPADDR': "10.0.4.230",
        'ANDROID_HOME': "/usr/local/opt/android-sdk",
        'ANDROID_NDK_ROOT': "/Applications/AndroidNDK7856742.app/Contents/NDK"
    }

def plawnekjxShellCommand(description, command, descriptionDone, **kwargs):
    args = dict(kwargs)
    args['name'] = descriptionDone.split(" ")[0]
    args['description'] = description
    args['descriptionDone'] = descriptionDone
    args['command'] = [ "bash", "-c", command ]
    args['env'] = makePlawnekjxEnv()
    return steps.ShellCommand(**args)

def plawnekjxInteractiveShellCommand(description, command, descriptionDone, **kwargs):
    args = dict(kwargs)
    args['name'] = descriptionDone.split(" ")[0]
    args['description'] = description
    args['descriptionDone'] = descriptionDone
    args['command'] = [ "bash", "-c", command ]
    args['env'] = makePlawnekjxEnv()
    args['usePTY'] = True
    return steps.ShellCommand(**args)

def plawnekjxVCShellCommand(description, arch, command, descriptionDone, **kwargs):
    args = dict(kwargs)
    args['name'] = descriptionDone.split(" ")[0]
    args['description'] = description
    args['descriptionDone'] = descriptionDone
    args['command'] = r"""set "VSCMD_START_DIR=%CD%" && "{0}\VC\Auxiliary\Build\vcvarsall.bat" {1} && {2}""".format(vsdir, arch, command)
    return steps.ShellCommand(**args)

def plawnekjxCompile(description, command, descriptionDone, **kwargs):
    args = dict(kwargs)
    args['name'] = descriptionDone.split(" ")[0]
    args['description'] = description
    args['descriptionDone'] = descriptionDone
    args['command'] = [ "bash", "-c", command ]
    args['env'] = makePlawnekjxEnv()
    return steps.Compile(**args)


win = BuildFactory()

win.addStep(Git(repourl="https://github.com/plawnekjx/plawnekjx.git", submodules=True))

win.addStep(steps.ShellCommand(
    name="roll-toolchain",
    description="rolling toolchain",
    command=[r"releng\deps.py roll toolchain windows-x86 --activate"],
    descriptionDone="roll toolchain",
    timeout=10000))
win.addStep(steps.ShellCommand(
    name="roll-sdk",
    description="rolling sdk",
    command=[r"releng\deps.py roll sdk windows-any"],
    descriptionDone="roll sdk",
    timeout=10000))

win.addStep(VS2022(installdir=vsdir,
    mode='rebuild',
    projectfile=r"plawnekjx.sln",
    config='Release|Win32',
    description="compiling Release|Win32",
    descriptionDone="compile Release|Win32"))
win.addStep(steps.ShellCommand(
    name="gum-tests",
    description="testing gum for Win32",
    command=[r"build\tmp-windows\Win32-Release\gum-tests\gum-tests.exe"],
    descriptionDone="test gum for Win32"))
win.addStep(steps.ShellCommand(
    name="plawnekjx-core-tests",
    description="testing core for Win32",
    command=[r"build\tmp-windows\Win32-Release\plawnekjx-tests\plawnekjx-tests.exe"],
    descriptionDone="test core for Win32"))
win.addStep(steps.ShellCommand(
    name="plawnekjx-python2-tests",
    description="testing python2 bindings for Win32",
    command=[r"C:\Program Files (x86)\Python 2.7\python.exe", "-m", "unittest", "tests.test_core"],
    workdir=r"build\plawnekjx-python",
    env={'PYTHONPATH': r"C:\Users\plawnekjx\Buildbot\plawnekjx-windows\build\build\plawnekjx-windows\Win32-Release\lib\python2.7\site-packages"},
    descriptionDone="test python2 bindings for Win32"))
win.addStep(steps.ShellCommand(
    name="plawnekjx-python3-tests",
    description="testing python3 bindings for Win32",
    command=[r"C:\Program Files (x86)\Python 3.10\python.exe", "-m", "unittest", "tests.test_core"],
    workdir=r"build\plawnekjx-python",
    env={'PYTHONPATH': r"C:\Users\plawnekjx\Buildbot\plawnekjx-windows\build\build\plawnekjx-windows\Win32-Release\lib\python3.10\site-packages"},
    descriptionDone="test python3 bindings for Win32"))

win.addStep(plawnekjxVCShellCommand(
    "preparing builddir for plawnekjx-qml Win32",
    "x86", r"rmdir /s /q plawnekjx-qml 2>nul & mkdir plawnekjx-qml & exit /b 0",
    "prepare builddir for plawnekjx-qml Win32",
    workdir=r"build\build\tmp-windows\Win32-Release"))
win.addStep(plawnekjxVCShellCommand(
    "generating nmake files for plawnekjx-qml Win32",
    "x86", r"C:\Qt\5.15.2\msvc2019\bin\qmake.exe QMAKE_TARGET.arch=x86 ..\..\..\..\plawnekjx-qml",
    "generate nmake files for plawnekjx-qml Win32",
    workdir=r"build\build\tmp-windows\Win32-Release\plawnekjx-qml"))
win.addStep(plawnekjxVCShellCommand(
    "building plawnekjx-qml Win32",
    "x86", r"nmake /f Makefile.Release install",
    "build plawnekjx-qml Win32",
    workdir=r"build\build\tmp-windows\Win32-Release\plawnekjx-qml"))

win.addStep(VS2022(installdir=vsdir,
    mode='rebuild',
    projectfile=r"plawnekjx.sln",
    config='Release|x64',
    description="compiling Release|x64",
    descriptionDone="compile Release|x64"))
win.addStep(steps.ShellCommand(
    name="gum-tests",
    description="testing gum for x64",
    command=[r"build\tmp-windows\x64-Release\gum-tests\gum-tests.exe"],
    descriptionDone="test gum for x64"))
win.addStep(steps.ShellCommand(
    name="plawnekjx-core-tests",
    description="testing core for x64",
    command=[r"build\tmp-windows\x64-Release\plawnekjx-tests\plawnekjx-tests.exe"],
    descriptionDone="test core for x64"))
win.addStep(steps.ShellCommand(
    name="plawnekjx-python2-tests",
    description="testing python2 bindings for x64",
    command=[r"C:\Program Files\Python 2.7\python.exe", "-m", "unittest", "tests.test_core"],
    workdir=r"build\plawnekjx-python",
    env={'PYTHONPATH': r"C:\Users\plawnekjx\Buildbot\plawnekjx-windows\build\build\plawnekjx-windows\x64-Release\lib\python2.7\site-packages"},
    descriptionDone="test python2 bindings for x64"))
win.addStep(steps.ShellCommand(
    name="plawnekjx-python3-tests",
    description="testing python3 bindings for x64",
    command=[r"C:\Program Files\Python 3.10\python.exe", "-m", "unittest", "tests.test_core"],
    workdir=r"build\plawnekjx-python",
    env={'PYTHONPATH': r"C:\Users\plawnekjx\Buildbot\plawnekjx-windows\build\build\plawnekjx-windows\x64-Release\lib\python3.10\site-packages"},
    descriptionDone="test python3 bindings for x64"))

win.addStep(plawnekjxVCShellCommand(
    "preparing builddir for plawnekjx-qml x64",
    "amd64", r"rmdir /s /q plawnekjx-qml 2>nul & mkdir plawnekjx-qml & exit /b 0",
    "prepare builddir for plawnekjx-qml x64",
    workdir=r"build\build\tmp-windows\x64-Release"))
win.addStep(plawnekjxVCShellCommand(
    "generating nmake files for plawnekjx-qml x64",
    "amd64", r"C:\Qt\5.15.2\msvc2019_64\bin\qmake.exe QMAKE_TARGET.arch=x86_64 ..\..\..\..\plawnekjx-qml",
    "generate nmake files for plawnekjx-qml x64",
    workdir=r"build\build\tmp-windows\x64-Release\plawnekjx-qml"))
win.addStep(plawnekjxVCShellCommand(
    "building plawnekjx-qml x64",
    "amd64", r"nmake /f Makefile.Release install",
    "build plawnekjx-qml x64",
    workdir=r"build\build\tmp-windows\x64-Release\plawnekjx-qml"))

win.addStep(steps.ShellCommand(
    name="release",
    description="releasing plawnekjx for windows",
    command=[r"releng\release.py", "windows"],
    descriptionDone="release plawnekjx for windows"))


def makeMacBuildCommandLine(*commands):
    return " && ".join(commands)

macos_modern = BuildFactory()
macos = macos_modern

macos.addStep(Git(repourl="https://github.com/plawnekjx/plawnekjx.git", submodules=True))
macos.addStep(plawnekjxCompile(
    "cleaning build environment",
    makeMacBuildCommandLine("make distclean"),
    "clean build environment"))

macos.addStep(plawnekjxCompile(
    "rolling dependencies",
    makeMacBuildCommandLine(
        "releng/deps.py roll toolchain macos-x86_64 --activate",
        "releng/deps.py roll toolchain macos-arm64",
        "releng/deps.py roll toolchain macos-arm64e",
        "releng/deps.py roll sdk macos-x86_64",
        "releng/deps.py roll sdk macos-arm64",
        "releng/deps.py roll sdk macos-arm64e",
        "releng/deps.py roll sdk ios-x86_64",
        "releng/deps.py roll sdk ios-arm64",
        "releng/deps.py roll sdk ios-arm64eoabi",
        "releng/deps.py roll sdk ios-arm64e",
        "releng/deps.py roll sdk android-x86_64",
        "releng/deps.py wait sdk android-arm",
        "releng/deps.py roll sdk android-arm64"
    ),
    "roll dependencies",
    timeout=10000))

macos.addStep(plawnekjxCompile(
    "cleaning build environment",
    makeMacBuildCommandLine("make distclean"),
    "clean build environment"))
macos.addStep(plawnekjxCompile(
    "building core for macos",
    makeMacBuildCommandLine("make core-macos"),
    "build core for macos"))
macos.addStep(plawnekjxCompile(
    "building gadget for macos",
    makeMacBuildCommandLine("make gadget-macos"),
    "build gadget for macos"))
macos.addStep(plawnekjxCompile(
    "building python bindings",
    makeMacBuildCommandLine(
        "make python-macos-apple_silicon PYTHON=/usr/local/bin/python3.8",
        "make python-macos-universal PYTHON=/usr/bin/python2.7",
        "make python-macos-universal PYTHON=/usr/local/bin/python3.8"
    ),
    "build python bindings"))
macos.addStep(plawnekjxCompile(
    "building node bindings",
    makeMacBuildCommandLine("make node-macos NODE=/usr/local/bin/node"),
    "build node bindings"))
macos.addStep(plawnekjxShellCommand(
    "building swift bindings",
    makeMacBuildCommandLine(
        "./releng/devkit.py plawnekjx-core macos-x86_64 ./plawnekjx-swift/CPlawnekjx/macos-x86_64/",
        "./releng/devkit.py plawnekjx-core macos-arm64 ./plawnekjx-swift/CPlawnekjx/macos-arm64/",
        "cd plawnekjx-swift/CPlawnekjx/",
        "mv macos-x86_64/plawnekjx-core.h .",
        "lipo -create macos-x86_64/libplawnekjx-core.a macos-arm64/libplawnekjx-core.a -output libplawnekjx-core.a",
        "rm -rf macos-x86_64 macos-arm64",
        "cd ..",
        "xcodebuild"
    ),
    "build swift bindings"))

macos.addStep(plawnekjxShellCommand(
    "testing gum",
    makeMacBuildCommandLine("make check-gum-macos"),
    "test gum"))
macos.addStep(plawnekjxShellCommand(
    "testing core",
    makeMacBuildCommandLine("make check-core-macos"),
    "test core"))
macos.addStep(plawnekjxInteractiveShellCommand(
    "testing python bindings",
    makeMacBuildCommandLine(
        "make check-python-macos PYTHON=/usr/bin/python2.7",
        "make check-python-macos PYTHON=/usr/local/bin/python3.8"
    ),
    "test python bindings"))
macos.addStep(plawnekjxInteractiveShellCommand(
    "testing node bindings",
    makeMacBuildCommandLine("make check-node-macos NODE=/usr/local/bin/node"),
    "test node bindings"))

macos.addStep(plawnekjxShellCommand(
    "releasing plawnekjx for macos",
    makeMacBuildCommandLine("releng/release.py macos-modern"),
    "release plawnekjx for macos",
    timeout=3600))


macos_legacy = BuildFactory()
macos = macos_legacy

macos.addStep(Git(repourl="https://github.com/plawnekjx/plawnekjx.git", submodules=True))
macos.addStep(plawnekjxCompile(
    "cleaning build environment",
    makeMacBuildCommandLine("make distclean"),
    "clean build environment"))

macos.addStep(plawnekjxCompile(
    "rolling dependencies",
    makeMacBuildCommandLine(
        "releng/deps.py wait sdk macos-x86_64",
        "releng/deps.py roll toolchain macos-x86 --activate",
        "rm -rf build",
        "export PLAWNEKJX_BUILD_ARCH=x86",
        "releng/deps.py roll sdk macos-x86",
        "releng/deps.py roll sdk ios-x86",
        "releng/deps.py roll sdk ios-arm",
        "releng/deps.py roll sdk android-x86",
        "releng/deps.py roll sdk android-arm",
        "releng/deps.py wait sdk android-arm64"
    ),
    "roll dependencies",
    timeout=10000))

macos.addStep(plawnekjxCompile(
    "cleaning build environment",
    makeMacBuildCommandLine("make distclean"),
    "clean build environment"))
macos.addStep(plawnekjxCompile(
    "building core for macos",
    makeMacBuildCommandLine("make core-macos"),
    "build core for macos"))
macos.addStep(plawnekjxShellCommand(
    "qmaking qml bindings",
    "rm -rf plawnekjx-qml && mkdir plawnekjx-qml && cd plawnekjx-qml && /Users/plawnekjx/Qt/5.15.0/clang_64/bin/qmake QMAKE_TARGET.arch=x86_64 ../../../plawnekjx-qml",
    "qmake qml bindings",
    workdir="build/build/tmp-macos-x86_64"))
macos.addStep(plawnekjxShellCommand(
    "building qml bindings",
    makeMacBuildCommandLine(
        "make -C build/tmp-macos-x86_64/plawnekjx-qml install",
        "strip -Sx build/plawnekjx-macos-x86_64/lib/qt5/qml/Plawnekjx/libplawnekjx-qml.dylib"
    ),
    "build qml bindings"))

macos.addStep(plawnekjxShellCommand(
    "testing gum",
    makeMacBuildCommandLine("make check-gum-macos"),
    "test gum"))
macos.addStep(plawnekjxShellCommand(
    "testing core",
    makeMacBuildCommandLine("make check-core-macos"),
    "test core"))

macos.addStep(plawnekjxShellCommand(
    "releasing plawnekjx for macos",
    makeMacBuildCommandLine("releng/release.py macos-legacy"),
    "release plawnekjx for macos",
    timeout=3600))


macos_m1 = BuildFactory()
macos = macos_m1

macos.addStep(Git(repourl="https://github.com/plawnekjx/plawnekjx.git", submodules=True))
macos.addStep(plawnekjxCompile(
    "cleaning build environment",
    makeMacBuildCommandLine("make clean"),
    "clean build environment"))

macos.addStep(plawnekjxCompile(
    "waiting for dependencies",
    "releng/deps.py wait sdk macos-arm64e",
    "wait for dependencies"))

macos.addStep(plawnekjxCompile(
    "building core for macos",
    makeMacBuildCommandLine("make core-macos"),
    "build core for macos"))
macos.addStep(plawnekjxCompile(
    "building node bindings",
    makeMacBuildCommandLine("make node-macos NODE=/usr/local/bin/node"),
    "build node bindings"))

macos.addStep(plawnekjxShellCommand(
    "testing gum",
    makeMacBuildCommandLine("make check-gum-macos"),
    "test gum"))
macos.addStep(plawnekjxShellCommand(
    "testing core",
    makeMacBuildCommandLine("make check-core-macos"),
    "test core"))
macos.addStep(plawnekjxInteractiveShellCommand(
    "testing node bindings",
    makeMacBuildCommandLine("make check-node-macos NODE=/usr/local/bin/node"),
    "test node bindings"))

macos.addStep(plawnekjxShellCommand(
    "releasing plawnekjx for macos",
    makeMacBuildCommandLine("releng/release.py macos-m1"),
    "release plawnekjx for macos",
    timeout=3600))


manylinux_x86_64 = BuildFactory()
linux = manylinux_x86_64

def makeLinuxBuildCommandLine(*commands):
    return " && ".join(commands)

linux.addStep(Git(repourl="https://github.com/plawnekjx/plawnekjx.git", submodules=True))
linux.addStep(plawnekjxCompile(
    "cleaning build environment",
    makeLinuxBuildCommandLine("make distclean"),
    "clean build environment"))

linux.addStep(plawnekjxCompile(
    "rolling dependencies",
    makeLinuxBuildCommandLine(
        "releng/deps.py roll toolchain linux-x86_64 --activate",
        "releng/deps.py roll toolchain linux-x86",
        "releng/deps.py roll sdk linux-x86",
        "releng/deps.py roll sdk linux-x86_64"
    ),
    "roll dependencies",
    timeout=10000))

linux.addStep(plawnekjxCompile(
    "cleaning build environment",
    makeLinuxBuildCommandLine("make distclean"),
    "clean build environment"))
linux.addStep(plawnekjxCompile(
    "building core",
    makeLinuxBuildCommandLine(
        "make core-linux-x86",
        "make core-linux-x86_64"
    ),
    "build core"))
linux.addStep(plawnekjxCompile(
    "building python bindings",
    makeLinuxBuildCommandLine(
        "make python-linux-x86    PYTHON=/opt/python-32/cp27-cp27mu/bin/python2.7",
        "make python-linux-x86    PYTHON=/opt/python-32/cp38-cp38/bin/python3.8",
        "make python-linux-x86_64 PYTHON=/opt/python-64/cp27-cp27mu/bin/python2.7",
        "make python-linux-x86_64 PYTHON=/opt/python-64/cp38-cp38/bin/python3.8"
    ),
    "build python bindings"))
linux.addStep(plawnekjxCompile(
    "building node bindings",
    makeLinuxBuildCommandLine(
        "make node-linux-x86    NODE=/opt/node-32/bin/node",
        "make node-linux-x86_64 NODE=/opt/node-64/bin/node"
    ),
    "build node bindings"))

linux.addStep(plawnekjxShellCommand(
    "testing gum",
    makeLinuxBuildCommandLine(
        "make check-gum-linux-x86",
        "make check-gum-linux-x86_64"
    ),
    "test gum"))
linux.addStep(plawnekjxShellCommand(
    "testing core",
    makeLinuxBuildCommandLine(
        "make check-core-linux-x86",
        "make check-core-linux-x86_64"
    ),
    "test core"))
linux.addStep(plawnekjxInteractiveShellCommand(
    "testing python bindings",
    makeLinuxBuildCommandLine(
        "make check-python-linux-x86    PYTHON=/opt/python-32/cp27-cp27mu/bin/python2.7",
        "make check-python-linux-x86    PYTHON=/opt/python-32/cp38-cp38/bin/python3.8",
        "make check-python-linux-x86_64 PYTHON=/opt/python-64/cp27-cp27mu/bin/python2.7",
        "make check-python-linux-x86_64 PYTHON=/opt/python-64/cp38-cp38/bin/python3.8"
    ),
    "test python bindings"))
linux.addStep(plawnekjxInteractiveShellCommand(
    "testing node bindings",
    makeLinuxBuildCommandLine(
        "make check-node-linux-x86    NODE=/opt/node-32/bin/node",
        "make check-node-linux-x86_64 NODE=/opt/node-64/bin/node"
    ),
    "test node bindings"))

linux.addStep(plawnekjxShellCommand(
    "releasing plawnekjx for linux-x86",
    makeLinuxBuildCommandLine("releng/release.py manylinux-x86_64"),
    "release plawnekjx for linux-x86",
    timeout=3600))


rpi32 = BuildFactory()
rpi = rpi32

rpi.addStep(Git(repourl="https://github.com/plawnekjx/plawnekjx.git", submodules=True))
rpi.addStep(plawnekjxCompile(
    "cleaning build environment",
    makeLinuxBuildCommandLine("make clean"),
    "clean build environment"))

rpi.addStep(plawnekjxCompile(
    "waiting for dependencies",
    "releng/deps.py wait sdk linux-armhf",
    "wait for dependencies"))

rpi.addStep(plawnekjxCompile(
    "building core",
    "make core-linux-armhf",
    "build core"))
rpi.addStep(plawnekjxCompile(
    "building python bindings",
    makeLinuxBuildCommandLine(
        "make python-linux-armhf PYTHON=/usr/bin/python2.7",
        "make python-linux-armhf PYTHON=/usr/bin/python3.7"
    ),
    "build python bindings"))
rpi.addStep(plawnekjxCompile(
    "building node bindings",
    makeLinuxBuildCommandLine(
        "make node-linux-armhf NODE=/usr/local/bin/node",
    ),
    "build node bindings"))

rpi.addStep(plawnekjxShellCommand(
    "testing gum",
    "make check-gum-linux-armhf",
    "test gum"))
rpi.addStep(plawnekjxShellCommand(
    "testing core",
    "make check-core-linux-armhf",
    "test core"))
rpi.addStep(plawnekjxInteractiveShellCommand(
    "testing python bindings",
    makeLinuxBuildCommandLine(
        "make check-python-linux-armhf PYTHON=/usr/bin/python2.7",
        "make check-python-linux-armhf PYTHON=/usr/bin/python3.7"
    ),
    "test python bindings"))
rpi.addStep(plawnekjxInteractiveShellCommand(
    "testing node bindings",
    makeLinuxBuildCommandLine(
        "make check-node-linux-armhf NODE=/usr/local/bin/node"
    ),
    "test node bindings"))

rpi.addStep(plawnekjxShellCommand(
    "releasing plawnekjx for rpi32",
    makeLinuxBuildCommandLine("releng/release.py rpi32"),
    "release plawnekjx for rpi32",
    timeout=3600))


rpi64 = BuildFactory()
rpi = rpi64

rpi.addStep(Git(repourl="https://github.com/plawnekjx/plawnekjx.git", submodules=True))
rpi.addStep(plawnekjxCompile(
    "cleaning build environment",
    makeLinuxBuildCommandLine("make distclean"),
    "clean build environment"))

rpi.addStep(plawnekjxCompile(
    "rolling dependencies",
    makeLinuxBuildCommandLine(
        "export PATH=/opt/python/bin:$PATH",
        "releng/deps.py roll toolchain linux-arm64 --activate",
        "releng/deps.py roll toolchain linux-armhf",
        "releng/deps.py roll sdk linux-armhf",
        "releng/deps.py roll sdk linux-arm64"
    ),
    "roll dependencies",
    timeout=10000))

rpi.addStep(plawnekjxCompile(
    "cleaning build environment",
    makeLinuxBuildCommandLine("make distclean"),
    "clean build environment"))
rpi.addStep(plawnekjxCompile(
    "building core",
    "make core-linux-arm64",
    "build core"))
rpi.addStep(plawnekjxCompile(
    "building python bindings",
    makeLinuxBuildCommandLine(
        "make python-linux-arm64 PYTHON=/usr/bin/python2.7",
        "make python-linux-arm64 PYTHON=/usr/bin/python3.7"
    ),
    "build python bindings"))
rpi.addStep(plawnekjxCompile(
    "building node bindings",
    "make node-linux-arm64 NODE=/usr/local/bin/node",
    "build node bindings"))

rpi.addStep(plawnekjxShellCommand(
    "testing gum",
    "make check-gum-linux-arm64",
    "test gum"))
rpi.addStep(plawnekjxShellCommand(
    "testing core",
    "make check-core-linux-arm64",
    "test core"))
rpi.addStep(plawnekjxInteractiveShellCommand(
    "testing python bindings",
    makeLinuxBuildCommandLine(
        "make check-python-linux-arm64 PYTHON=/usr/bin/python2.7",
        "make check-python-linux-arm64 PYTHON=/usr/bin/python3.7"
    ),
    "test python bindings"))
rpi.addStep(plawnekjxInteractiveShellCommand(
    "testing node bindings",
    "make check-node-linux-arm64 NODE=/usr/local/bin/node",
    "test node bindings"))

rpi.addStep(plawnekjxShellCommand(
    "releasing plawnekjx for rpi64",
    makeLinuxBuildCommandLine("releng/release.py rpi64"),
    "release plawnekjx for rpi64",
    timeout=3600))


ios = BuildFactory()

ios.addStep(Git(repourl="https://github.com/plawnekjx/plawnekjx.git", submodules=True))
ios.addStep(plawnekjxCompile(
    "cleaning build environment",
    makeMacBuildCommandLine("make clean"),
    "clean build environment"))

ios.addStep(plawnekjxCompile(
    "waiting for dependencies",
    "releng/deps.py wait sdk ios-arm64e",
    "wait for dependencies"))

ios.addStep(plawnekjxCompile(
    "building core for ios",
    makeMacBuildCommandLine("make core-ios"),
    "build core for ios"))
ios.addStep(plawnekjxCompile(
    "building gadget for ios",
    makeMacBuildCommandLine("make gadget-ios"),
    "build gadget for ios"))
ios.addStep(plawnekjxCompile(
    "building .deb for ios",
    makeMacBuildCommandLine("make deb-ios"),
    "build .deb for ios"))

ios.addStep(plawnekjxShellCommand(
    "releasing plawnekjx for ios",
    makeMacBuildCommandLine("releng/release.py ios"),
    "release plawnekjx for ios",
    timeout=3600))


android = BuildFactory()

android.addStep(Git(repourl="https://github.com/plawnekjx/plawnekjx.git", submodules=True))
android.addStep(plawnekjxCompile(
    "cleaning build environment",
    makeMacBuildCommandLine("make clean"),
    "clean build environment"))

android.addStep(plawnekjxCompile(
    "waiting for dependencies",
    "releng/deps.py wait sdk android-arm64",
    "wait for dependencies"))

android.addStep(plawnekjxCompile(
    "building core",
    "make core-android-x86 core-android-x86_64 core-android-arm core-android-arm64",
    "build core"))

android.addStep(plawnekjxCompile(
    "building python bindings",
    "make build/tmp-android-arm64/plawnekjx-python3.8/.plawnekjx-stamp PYTHON_NAME=python3.8 PYTHON_INCDIR=$(/usr/local/bin/python3.8 -c 'from distutils import sysconfig; import sys; sys.stdout.write(sysconfig.get_python_inc())')",
    "build python bindings"))

android.addStep(plawnekjxShellCommand(
    "releasing plawnekjx for android",
    makeMacBuildCommandLine("releng/release.py android"),
    "release plawnekjx for android",
    timeout=3600))


ubuntu_18_04_x86_64 = BuildFactory()
ubuntu = ubuntu_18_04_x86_64

ubuntu.addStep(Git(repourl="https://github.com/plawnekjx/plawnekjx.git", submodules=True))
ubuntu.addStep(plawnekjxCompile(
    "cleaning build environment",
    "make distclean",
    "clean build environment"))

ubuntu.addStep(plawnekjxCompile(
    "rolling dependencies",
    makeLinuxBuildCommandLine(
        "export PATH=/opt/python/bin:$PATH",
        "python3.8 releng/deps.py roll toolchain linux-arm64 --activate",
        "python3.8 releng/deps.py roll toolchain linux-armhf",
        "make -f Makefile.sdk.mk build/fs-env-linux-armhf.rc build/fs-env-linux-arm64.rc",
        r"sed -i -e 's,\[properties\],[properties]\nneeds_exe_wrapper = false,' build/fs-linux-armhf.txt",
        r"sed -i -e 's,\[properties\],[properties]\nneeds_exe_wrapper = false,' build/fs-linux-arm64.txt",
        "QEMU_LD_PREFIX=/usr/arm-linux-gnueabihf python3.8 releng/deps.py roll sdk linux-armhf",
        "QEMU_LD_PREFIX=/usr/aarch64-linux-gnu python3.8 releng/deps.py roll sdk linux-arm64"
    ),
    "roll dependencies",
    timeout=10000))

ubuntu.addStep(plawnekjxCompile(
    "building core",
    "make core-linux-armhf core-linux-arm64",
    "build core"))

ubuntu.addStep(plawnekjxShellCommand(
    "releasing plawnekjx",
    makeLinuxBuildCommandLine("python3.8 releng/release.py ubuntu_18_04-x86_64"),
    "release plawnekjx",
    timeout=3600))


ubuntu_18_04_armhf = BuildFactory()
ubuntu = ubuntu_18_04_armhf

ubuntu.addStep(Git(repourl="https://github.com/plawnekjx/plawnekjx.git", submodules=True))
ubuntu.addStep(plawnekjxCompile(
    "cleaning build environment",
    "make clean",
    "clean build environment"))

ubuntu.addStep(plawnekjxCompile(
    "waiting for dependencies",
    "python3.8 releng/deps.py wait sdk linux-armhf",
    "wait for dependencies"))

ubuntu.addStep(plawnekjxCompile(
    "building python bindings",
    makeLinuxBuildCommandLine(
        "make python-linux-armhf PYTHON=/usr/bin/python2.7",
        "make python-linux-armhf PYTHON=/usr/bin/python3.6"
    ),
    "build python bindings"))

ubuntu.addStep(plawnekjxShellCommand(
    "releasing plawnekjx",
    makeLinuxBuildCommandLine("python3.8 releng/release.py ubuntu_18_04-armhf"),
    "release plawnekjx",
    timeout=3600))


ubuntu_18_04_arm64 = BuildFactory()
ubuntu = ubuntu_18_04_arm64

ubuntu.addStep(Git(repourl="https://github.com/plawnekjx/plawnekjx.git", submodules=True))
ubuntu.addStep(plawnekjxCompile(
    "cleaning build environment",
    "make clean",
    "clean build environment"))

ubuntu.addStep(plawnekjxCompile(
    "waiting for dependencies",
    "python3.8 releng/deps.py wait sdk linux-arm64",
    "wait for dependencies"))

ubuntu.addStep(plawnekjxCompile(
    "building python bindings",
    makeLinuxBuildCommandLine(
        "make python-linux-arm64 PYTHON=/usr/bin/python2.7",
        "make python-linux-arm64 PYTHON=/usr/bin/python3.6"
    ),
    "build python bindings"))

ubuntu.addStep(plawnekjxShellCommand(
    "releasing plawnekjx",
    makeLinuxBuildCommandLine("python3.8 releng/release.py ubuntu_18_04-arm64"),
    "release plawnekjx",
    timeout=3600))


ubuntu_20_04_x86_64 = BuildFactory()
ubuntu = ubuntu_20_04_x86_64

ubuntu.addStep(Git(repourl="https://github.com/plawnekjx/plawnekjx.git", submodules=True))
ubuntu.addStep(plawnekjxCompile(
    "cleaning build environment",
    "make clean",
    "clean build environment"))

ubuntu.addStep(plawnekjxCompile(
    "waiting for dependencies",
    "releng/deps.py wait sdk linux-x86_64",
    "wait for dependencies"))

ubuntu.addStep(plawnekjxCompile(
    "building python bindings",
    "LD=/usr/bin/ld.gold make python-linux-x86_64 PYTHON=/usr/bin/python3.8",
    "build python bindings"))
ubuntu.addStep(plawnekjxShellCommand(
    "qmaking qml bindings",
    "rm -rf plawnekjx-qml && mkdir plawnekjx-qml && cd plawnekjx-qml && /opt/qt/bin/qmake ../../../plawnekjx-qml",
    "qmake qml bindings",
    workdir="build/build/tmp-linux-x86_64"))
ubuntu.addStep(plawnekjxShellCommand(
    "building qml bindings",
    makeMacBuildCommandLine(
        "make -C build/tmp-linux-x86_64/plawnekjx-qml install",
        "strip --strip-all build/plawnekjx-linux-x86_64/lib/qt5/qml/Plawnekjx/libplawnekjx-qml.so"
    ),
    "build qml bindings"))

ubuntu.addStep(plawnekjxInteractiveShellCommand(
    "testing python bindings",
    "make check-python-linux-x86_64 PYTHON=/usr/bin/python3.8",
    "test python bindings"))

ubuntu.addStep(plawnekjxShellCommand(
    "releasing plawnekjx for ubuntu",
    "releng/release.py ubuntu_20_04-x86_64",
    "release plawnekjx for ubuntu",
    timeout=3600))


ubuntu_21_04_x86_64 = BuildFactory()
ubuntu = ubuntu_21_04_x86_64

ubuntu.addStep(Git(repourl="https://github.com/plawnekjx/plawnekjx.git", submodules=True))
ubuntu.addStep(plawnekjxCompile(
    "cleaning build environment",
    "make clean",
    "clean build environment"))

ubuntu.addStep(plawnekjxCompile(
    "waiting for dependencies",
    "releng/deps.py wait sdk linux-x86_64",
    "wait for dependencies"))

ubuntu.addStep(plawnekjxCompile(
    "building python bindings",
    "LD=/usr/bin/ld.gold make python-linux-x86_64 PYTHON=/usr/bin/python3.9",
    "build python bindings"))

ubuntu.addStep(plawnekjxInteractiveShellCommand(
    "testing python bindings",
    "make check-python-linux-x86_64 PYTHON=/usr/bin/python3.9",
    "test python bindings"))

ubuntu.addStep(plawnekjxShellCommand(
    "releasing plawnekjx for ubuntu",
    "releng/release.py ubuntu_21_04-x86_64",
    "release plawnekjx for ubuntu",
    timeout=3600))


fedora_35_x86_64 = BuildFactory()
fedora = fedora_35_x86_64

fedora.addStep(Git(repourl="https://github.com/plawnekjx/plawnekjx.git", submodules=True))
fedora.addStep(plawnekjxCompile(
    "cleaning build environment",
    "make clean",
    "clean build environment"))

fedora.addStep(plawnekjxCompile(
    "waiting for dependencies",
    "releng/deps.py wait sdk linux-x86_64",
    "wait for dependencies"))

fedora.addStep(plawnekjxCompile(
    "building python bindings",
    "LD=/usr/bin/ld.gold make python-linux-x86_64 PYTHON=/usr/bin/python3.10",
    "build python bindings"))

fedora.addStep(plawnekjxInteractiveShellCommand(
    "testing python bindings",
    "make check-python-linux-x86_64 PYTHON=/usr/bin/python3.10",
    "test python bindings"))

fedora.addStep(plawnekjxShellCommand(
    "releasing plawnekjx for fedora",
    "releng/release.py fedora_35-x86_64",
    "release plawnekjx for fedora",
    timeout=3600))


website = BuildFactory()

website.addStep(Git(repourl="https://github.com/plawnekjx/plawnekjx-website.git"))

website.addStep(plawnekjxShellCommand(
    "updating website",
    makeMacBuildCommandLine(
        "git clean -xffd",
        "/usr/local/opt/ruby/bin/bundle exec jekyll build",
        "./_releng/deploy.py"
    ),
    "update website"))


from buildbot.plugins import util

c['builders'] = [
    util.BuilderConfig(name="plawnekjx-windows", workername="windows", factory=win),
    util.BuilderConfig(name="plawnekjx-macos-m1", workername="mac-m1", factory=macos_m1),
    util.BuilderConfig(name="plawnekjx-macos-modern", workername="mac-bigsur", factory=macos_modern),
    util.BuilderConfig(name="plawnekjx-macos-legacy", workername="mac-mojave", factory=macos_legacy),
    util.BuilderConfig(name="plawnekjx-manylinux-x86_64", workername="manylinux-x86_64", factory=manylinux_x86_64),
    #util.BuilderConfig(name="plawnekjx-rpi32", workername="rpi32", factory=rpi32),
    #util.BuilderConfig(name="plawnekjx-rpi64", workername="rpi64", factory=rpi64),
    util.BuilderConfig(name="plawnekjx-ios", workername="mac-bigsur", factory=ios),
    util.BuilderConfig(name="plawnekjx-android", workername="mac-mojave", factory=android),

    util.BuilderConfig(name="plawnekjx-ubuntu_18_04-x86_64", workername="ubuntu_18_04-x86_64", factory=ubuntu_18_04_x86_64),
    util.BuilderConfig(name="plawnekjx-ubuntu_18_04-armhf", workername="ubuntu_18_04-armhf", factory=ubuntu_18_04_armhf),
    util.BuilderConfig(name="plawnekjx-ubuntu_18_04-arm64", workername="ubuntu_18_04-arm64", factory=ubuntu_18_04_arm64),
    util.BuilderConfig(name="plawnekjx-ubuntu_20_04-x86_64", workername="ubuntu_20_04-x86_64", factory=ubuntu_20_04_x86_64),
    util.BuilderConfig(name="plawnekjx-ubuntu_21_04-x86_64", workername="ubuntu_21_04-x86_64", factory=ubuntu_21_04_x86_64),
    util.BuilderConfig(name="plawnekjx-fedora_35-x86_64", workername="fedora_35-x86_64", factory=fedora_35_x86_64),

    util.BuilderConfig(name="plawnekjx-website", workername="mac-mojave", factory=website),
]


####### STATUS TARGETS

from buildbot.plugins import reporters

c['www'] = dict(port=8010,
                plugins=dict(waterfall_view={}, console_view={}),
                change_hook_dialects={ 'github': {} })

irc = reporters.IRC("irc.freenode.net", "plawnekjxbb",
                    useColors=False,
                    channels=[{"channel": "#plawnekjx"}],
                    notify_events={
                      'exception': 1,
                      'successToFailure': 1,
                      'failureToSuccess': 1,
                    })
c['services'] = [irc]


####### PROJECT IDENTITY

c['title'] = "Plawnekjx"
c['titleURL'] = "https://plawnekjx.re/"

c['buildbotURL'] = params.BUILDBOT_URL


####### DB URL

c['db'] = {
    'db_url' : "sqlite:///state.sqlite",
}
